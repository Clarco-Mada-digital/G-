{% extends 'layout/layout.html' %}

{% block title %}Détails des Dépenses{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-8">Détails des Dépenses</h1>
    <!-- Formulaire de filtrage et tri -->
    <form method="get" class="mb-8">
        <div class="flex space-x-4">
            <input type="date" name="date_debut" value="{{ date_debut }}"
                class="border rounded px-2 py-1">
            <input type="date" name="date_fin" value="{{ date_fin }}"
                class="border rounded px-2 py-1">
            <select name="tri" class="border rounded px-2 py-1">
                <option {% if tri == '-date_de_sortie' %}selected{% endif %}
                    value="-date_de_sortie">Date (récent)</option>
                <option {% if tri == 'date_de_sortie' %}selected{% endif %}
                    value="date_de_sortie">Date (ancien)</option>
                <option {% if tri == '-montant' %}selected{% endif %}
                    value="-montant">Montant (décroissant)</option>
                <option {% if tri == 'montant' %}selected{% endif %}
                    value="montant">Montant (croissant)</option>
            </select>
            <button type="submit"
                class="bg-blue-500 text-white px-4 py-2 rounded">Filtrer</button>
        </div>
    </form>

    <!-- Dépenses par Employés -->
    <div class="bg-white rounded-lg border mb-8">
        <div class="p-4 border-b">
            <h2 class="text-xl font-semibold">Détails des Dépenses par
                Employés</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="bg-gray-100">
                        <th class="p-2 text-left">Employé</th>
                        <th class="p-2 text-left">Total des dépenses</th>
                        <th class="p-2 text-left">Nombre total des dépenses</th>
                    </tr>
                </thead>
                <tbody>
                    {% for depense in depenses_par_employe %}
                    <tr class="border-b">
                        <td class="p-2">{{
                            depense.beneficiaire__personnel__first_name }} {{
                            depense.beneficiaire__personnel__last_name }}</td>
                        <td class="p-2">{{ depense.total_depenses|floatformat:0
                            }} Ar</td>
                        <td class="p-2">{{ depense.nombre_depenses }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Dépenses par Catégories -->
    <div class="bg-white rounded-lg border mb-8">
        <div class="p-4 border-b">
            <h2 class="text-xl font-semibold">Détails des Dépenses par
                Catégories</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="bg-gray-100">
                        <th class="p-2 text-left">Catégorie</th>
                        <th class="p-2 text-left">Total des dépenses</th>
                        <th class="p-2 text-left">Nombre total des dépenses</th>
                    </tr>
                </thead>
                <tbody>
                    {% for depense in depenses_par_categorie %}
                    <tr class="border-b">
                        <td class="p-2">{{ depense.categorie__name }}</td>
                        <td class="p-2">{{ depense.total_depenses|floatformat:0
                            }} Ar</td>
                        <td class="p-2">{{ depense.nombre_depenses }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Liste détaillée des opérations -->
    <div class="bg-white rounded-lg border">
        <div class="p-4 border-b">
            <h2 class="text-xl font-semibold">Liste des Opérations</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="bg-gray-100">
                        <th class="p-2 text-left">Date</th>
                        <th class="p-2 text-left">Description</th>
                        <th class="p-2 text-left">Bénéficiaire</th>
                        <th class="p-2 text-left">Catégorie</th>
                        <th class="p-2 text-left">Montant</th>
                        <th class="p-2 text-left">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for operation in page_obj %}
                    <tr class="border-b">
                        <td class="p-2">{{ operation.date_de_sortie }}</td>
                        <td class="p-2">{{ operation.description }}</td>
                        <td class="p-2">{{ operation.beneficiaire }}</td>
                        <td class="p-2">{{ operation.categorie.name }}</td>
                        <td class="p-2">{{ operation.montant|floatformat:0 }}
                            Ar</td>
                        <td class="p-2">
                            <a
                                href="{% url 'modifier_operation' operation.id %}"
                                class="text-blue-500 hover:underline">Modifier</a>
                            <a
                                href="{% url 'supprimer_operation' operation.id %}"
                                class="text-red-500 hover:underline ml-2"
                                onclick="return confirm('Êtes-vous sûr de vouloir supprimer cette opération ?')">Supprimer</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    <div class="mt-4">
        <span class="step-links">
            {% if page_obj.has_previous %}
            <a href="?page=1">&laquo; première</a>
            <a href="?page={{ page_obj.previous_page_number }}">précédente</a>
            {% endif %}

            <span class="current">
                Page {{ page_obj.number }} sur {{ page_obj.paginator.num_pages
                }}.
            </span>

            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}">suivante</a>
            <a href="?page={{ page_obj.paginator.num_pages }}">dernière
                &raquo;</a>
            {% endif %}
        </span>
    </div>
</div>
{% endblock %}
