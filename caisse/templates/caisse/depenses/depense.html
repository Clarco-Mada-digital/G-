{% extends 'layout/layout.html' %}
{% load static %}

{% block title_page %}Détails des Dépenses{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">

    <div class=" overflow-hidden mb-8">
        <div class="flex justify-between items-center p-4">
            <h2 class="text-xl font-semibold dark:text-white">Détails des
                Dépenses par
                Employés</h2>
            <select id="moisSelect" class="border rounded px-12 py-1"
                onchange="updateMonth(this.value)">
                {% for mois in mois_liste %}
                <option value="{{ mois.value }}"
                    {% if mois.value == mois_selectionne %}selected{% endif %}>
                    {{ mois.label }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="bg-white dark:bg-secondary rounded-2xl p-4">
            <table
                class=" divide-gray-200 dark:divide-gray-600 text-gray-800 dark:text-gray-400 text-center">
                <thead class>
                    <tr>
                        <th
                            class="px-6 py-3 text-left text-md font-medium text-gray-500 dark:text-white tracking-wider">Employé</th>
                        <th
                            class="px-6 py-3 text-left text-md font-medium text-gray-500 dark:text-white tracking-wider">Total
                            des dépenses</th>
                        <th
                            class="px-6 py-3 text-left text-md font-medium text-gray-500 dark:text-white                                                                                 tracking-wider">Catégorie
                            la plus dépensée</th>
                        <th
                            class="px-6 py-3 text-left text-md font-medium text-gray-500 dark:text-white tracking-wider">Nombre
                            total des dépenses</th>
                        <th
                            class="px-6 py-3 text-left text-md font-medium text-gray-500 dark:text-white tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody
                    class="bg-white dark:bg-secondary divide-y divide-gray-200 dark:divide-gray-600 p-4">
                    {% for depense in depenses_par_employe %}
                    <tr>
                        <td class="    py-4 whitespace-nowrap">
                            {{ depense.beneficiaire__personnel__first_name }}
                        </td>
                        <td class="    py-4 whitespace-nowrap">
                            {{ depense.total_depenses }} Ar
                        </td>
                        <td class="    py-4 whitespace-nowrap">
                            {{ depense.categorie_plus_depensee }}
                        </td>
                        <td class="    py-4 whitespace-nowrap">
                            {{ depense.nombre_depenses }}
                        </td>
                        <td class="    py-4 whitespace-nowrap">
                            <button
                                class="text-primary hover:text-primary">•••</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Dépenses par Catégories -->
    <h2
        class="text-xl font-semibold text-gray-700 dark:text-white mt-16  mb-3">Détails
        des
        Dépenses
        par
        Catégories</h2>
    <div class="bg-white dark:bg-gray-600 rounded-2xl overflow-hidden mb-8">

        <table
            class="min-w-full divide-y divide-gray-200 py-4 text-gray-800 dark:text-white">
            <thead class="text-center">
                <tr>
                    <th
                        class="px-6 py-3 text-left text-md font-medium text-gray-800  tracking-wider">Catégorie</th>
                    <th
                        class="px-6 py-3 text-left text-md font-medium text-gray-800  tracking-wider">Total
                        des dépenses</th>
                    <th
                        class="px-6 py-3 text-left text-md font-medium text-gray-800  tracking-wider">Nombre
                        total des dépenses</th>
                    <th
                        class="px-6 py-3 text-left text-md font-medium text-gray-800  tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody
                class="bg-white dark:bg-secondary text-center divide-y divide-gray-200">
                {% for depense in depenses_par_categorie %}
                <tr>
                    <td class=" text-gray-600  py-4 ">
                        {{ depense.categorie__name }}
                    </td>
                    <td class=" text-gray-600  py-4 ">
                        {{ depense.total_depenses }} Ar
                    </td>
                    <td class=" text-gray-600  py-4 ">
                        {{ depense.nombre_depenses }}
                    </td>
                    <td class=" text-gray-600  py-4 ">
                        <button
                            class="text-primary hover:text-primary">•••</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Graphiques -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-16">
        <!-- Graphique par Catégories -->
        <div class>
            <div class="flex justify-between items-center mb-4">
                <h2
                    class="text-xl font-semibold text-gray-700 ">Graphique
                    par catégories</h2>
                <select id="graphiqueSelect"
                    class="border-none rounded-xl px-12 py-2"
                    onchange="updateGraphType(this.value)">
                    <option value="mensuel">Mensuel</option>
                    <option value="annuel">Annuel</option>
                </select>
            </div>
            <div class="bg-white dark:bg-secondary rounded-2xl p-4"
                style="height: 400px;">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>

        <!-- Graphique Dépenses par année -->
        <div>
            <h2 class="text-xl font-semibold mb-4">Dépenses par année</h2>
            <div class="bg-white rounded-2xl p-4" style="height: 400px;">
                <canvas id="yearlyExpensesChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> -->
<script>
    function updateMonth(mois) {
        const url = new URL(window.location);
        url.searchParams.set('mois', mois);
        window.location.href = url.toString();
    }

    function updateGraphType(type) {
        const url = new URL(window.location);
        url.searchParams.set('graph_type', type);
        window.location.href = url.toString();
    }

    function filterTableByCategory(category) {
        const tables = document.querySelectorAll('table tbody tr');
        
        tables.forEach(row => {
            const categoryCell = row.querySelector('td:first-child');
            if (!categoryCell) return;
            
            if (!category || categoryCell.textContent.trim() === category) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });

        // Mettre à jour le graphique
        updateChartByCategory(category);
    }

    function updateChartByCategory(category) {
        const chartData = {
            labels: [],
            data: [],
            colors: []
        };

        // Récupérer les données filtrées
        const tables = document.querySelectorAll('table tbody tr');
        tables.forEach(row => {
            const categoryCell = row.querySelector('td:first-child');
            const amountCell = row.querySelector('td:nth-child(2)');
            if (!categoryCell || !amountCell) return;

            const categoryName = categoryCell.textContent.trim();
            if (!category || categoryName === category) {
                chartData.labels.push(categoryName);
                // Convertir le montant en nombre (enlever "Ar" et les espaces)
                const amount = parseFloat(amountCell.textContent.replace('Ar', '').trim());
                chartData.data.push(amount);
                // Utiliser la même couleur que celle définie dans la vue
                const colorIndex = chartData.labels.length - 1;
                chartData.colors.push(colors[colorIndex % colors.length]);
            }
        });

        // Mettre à jour le graphique
        if (categoryChart) {
            categoryChart.data.labels = chartData.labels;
            categoryChart.data.datasets[0].data = chartData.data;
            categoryChart.data.datasets[0].backgroundColor = chartData.colors;
            categoryChart.update();
        }
    }

    // Définir les couleurs pour les catégories
    const colors = [
        '#396AFF', '#16DBCC', '#FF82AC', '#FFB800', '#4040FF',
        '#EC4899', '#8B5CF6', '#14B8A6', '#F97316', '#06B6D4'
    ];

    document.addEventListener('DOMContentLoaded', function() {
        // Synchroniser les sélecteurs de mois
        const moisSelect = document.getElementById('moisSelect');
        const moisSelectCategories = document.getElementById('moisSelectCategories');
        
        if (moisSelect && moisSelectCategories) {
            moisSelectCategories.innerHTML = moisSelect.innerHTML;
            moisSelectCategories.value = moisSelect.value;
            
            moisSelectCategories.addEventListener('change', function() {
                updateMonth(this.value);
            });
        }
        // Graphique par Catégories
        const ctxCategory = document.getElementById('categoryChart').getContext('2d');
        
        // Préparer les données initiales
        const initialData = {
            labels: [{% for depense in depenses_par_categorie %}'{{ depense.categorie__name }}',{% endfor %}],
            data: [{% for depense in depenses_par_categorie %}{{ depense.total_depenses }},{% endfor %}]
        };

        const categoryChart = new Chart(ctxCategory, {
            type: 'bar',
            data: {
                labels: initialData.labels,
                datasets: [{
                    label: 'Dépenses par Catégorie',
                    data: initialData.data,
                    backgroundColor: colors.slice(0, initialData.labels.length),
                    borderRadius: 10,
                    barThickness: 40
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        position: 'left',
                        ticks: {
                            callback: function(value) {
                                return 'Ar ' + value.toLocaleString('fr-FR');
                            },
                            font: {
                                size: 12,
                                weight: 'bold'
                            }
                        },
                        grid: {
                            color: 'rgba(200, 200, 200, 0.3)'
                        },
                        max: Math.max(...initialData.data) * 1.1
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: 12,
                                weight: 'bold'
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        // align: 'start',
                        labels: {
                            font: {
                                size: 12
                            },
                            usePointStyle: true,
                            padding: 20,
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => {
                                        const value = data.datasets[0].data[i];
                                        const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        
                                        return {
                                            text: `${label} ${percentage}%`,
                                            fillStyle: data.datasets[0].backgroundColor[i],
                                            index: i
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${context.label}: ${percentage}% (Ar ${value.toLocaleString('fr-FR')})`;
                            }
                        }
                    }
                },
                layout: {
                    padding: {
                        top: 30,
                        bottom: 30,
                        left: 20,
                        right: 20
                    }
                },
                animation: {
                    duration: 0 // Désactive l'animation
                }
            }
        });

        // Rendre le graphique accessible globalement pour les mises à jour
        window.categoryChart = categoryChart;

        // Limiter le nombre de catégories affichées
        const maxCategories = 10; // Nombre maximum de catégories à afficher
        if (categoryChart.data.labels.length > maxCategories) {
            categoryChart.data.labels = categoryChart.data.labels.slice(0, maxCategories);
            categoryChart.data.datasets[0].data = categoryChart.data.datasets[0].data.slice(0, maxCategories);
            categoryChart.data.datasets[0].backgroundColor = categoryChart.data.datasets[0].backgroundColor.slice(0, maxCategories);
        }

        categoryChart.update();

        // Graphique Dépenses par année
        const ctxYearly = document.getElementById('yearlyExpensesChart').getContext('2d');
        new Chart(ctxYearly, {
            type: 'line',
            data: {
                labels: [{% for depense in depenses_par_annee %}'{{ depense.year|date:"Y" }}',{% endfor %}],
                datasets: [{
                    label: 'Dépenses par année',
                    data: [{% for depense in depenses_par_annee %}{{ depense.total_depenses }},{% endfor %}],
                    borderColor: '#EDA10D',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + ' Ar';
                            }
                        }
                    }
                }
            }
        });

        // Initialiser le filtre de catégorie
        const categorieFilter = document.getElementById('categorieFilter');
        if (categorieFilter) {
            const urlParams = new URLSearchParams(window.location.search);
            const selectedCategory = urlParams.get('categorie');
            if (selectedCategory) {
                categorieFilter.value = selectedCategory;
                filterTableByCategory(selectedCategory);
            }
        }
    });
</script>
{% endblock %}
