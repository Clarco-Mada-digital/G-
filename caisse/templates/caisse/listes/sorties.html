<!-- templates/listes/index.html -->
{% extends 'layout/layout.html' %}
{% load humanize %}

{% block title_page %}Liste des Opérations{% endblock %}

{% block content %}
<div class="dark:text-white">

    <!-- Navigation entre Entrées et Sorties -->
    <div class="flex justify-between dark:text-white  space-x-4 mb-4  items-center">
        <div> </div>
        <div class="flex space-x-4 p-2 rounded-xl bg-white dark:bg-secondary border-none">
            <a href="{% url 'caisse:listes' %}">
                <svg width="48" height="43" viewBox="0 0 48 43" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6.98404 27.141L12.0931 22.721C14.6792 20.4837 18.716 20.2654 21.6175 22.0661L24.6451 19.4469C23.7621 18.4101 23.2575 17.155 23.2575 15.7908C23.2575 14.0992 24.0144 12.4622 25.402 11.2617L30.5111 6.84167C33.3495 4.38611 38.0171 4.38611 40.9185 6.84167C42.2431 8.09673 43 9.67921 43 11.3708C43 13.0624 42.2431 14.6449 40.8554 15.8454L35.8094 20.2654C34.3587 21.5205 32.4664 22.1207 30.6373 22.1207C29.2496 22.1207 27.925 21.7933 26.7266 21.1385L23.5728 23.8669C24.3297 24.8491 24.7082 26.0496 24.7082 27.2501C24.7082 28.9417 23.9513 30.5242 22.5636 31.7247L17.5176 36.1447C16.0669 37.3997 14.1746 38 12.3454 38C10.4532 38 8.56092 37.3997 7.17326 36.1447C5.78561 34.9442 5.02871 33.3617 5.02871 31.6701C4.83948 29.9785 5.59638 28.396 6.98404 27.141ZM33.791 18.5192L38.837 14.0992C39.7201 13.3353 40.1616 12.353 40.1616 11.3162C40.1616 10.2795 39.7201 9.29723 38.837 8.53328C37.954 7.76933 36.8186 7.38735 35.6202 7.38735C34.4848 7.38735 33.2864 7.76933 32.4034 8.53328L27.2943 12.8987C26.4743 13.6627 25.9697 14.6449 25.9697 15.6817C25.9697 16.3911 26.1589 16.9913 26.5374 17.5916L28.1142 16.2274C28.6819 15.7363 29.565 15.7363 30.1327 16.2274C30.7003 16.7185 30.7003 17.4824 30.1327 17.9735L28.6819 19.2286C30.448 19.9926 32.4664 19.7197 33.791 18.5192ZM9.06552 34.3985C10.8316 35.9264 13.7331 35.9264 15.4361 34.3985L20.4821 29.9785C21.3652 29.2146 21.8067 28.2323 21.8067 27.1955C21.8067 26.6499 21.6806 26.1042 21.4283 25.6131L19.9775 26.8136C19.7252 27.0318 19.3468 27.1955 18.9683 27.1955C18.5899 27.1955 18.2114 27.0864 17.9591 26.8136C17.3915 26.3224 17.3915 25.5585 17.9591 25.0674L19.536 23.8669C18.8422 23.5395 18.0853 23.3758 17.3284 23.3758C16.193 23.3758 14.9946 23.7577 14.1115 24.5217L9.00245 28.8871C8.18247 29.6511 7.67787 30.6333 7.67787 31.6701C7.74094 32.7069 8.18247 33.6891 9.06552 34.3985Z" fill="#396AFF" class="dark:fill-[#FFFFFF]"/>
                    </svg>
            </a>
            <a href="{% url 'caisse:liste_entrees' %}" class="bg-white dark:bg-secondary text-secondary dark:text-white font-bold py-2 px-6 rounded">
                Entrées
            </a>
            <a href="{% url 'caisse:liste_sorties' %}" class="bg-rose-200 hover:bg-rose-100 text-rose-500 font-bold py-2 px-4 rounded-xl">
                Sorties
            </a>
        </div>
        <div><a href="{% url 'caisse:operation' %}">
            <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Nouvelle Opération</button>
        </a>
        </div>
    </div>

    <div class="flex justify-between items-center space-x-4">
        <!-- Sélecteur pour le nombre de lignes par page -->
        <form method="get" class="flex items-center space-x-2">
            <label for="lignes">Nombre de lignes :</label>
            <select name="lignes" class="border-none dark:bg-secondary focus:ring-0" id="lignes" onchange="this.form.submit()">
                <option value="5" {% if lignes_par_page == '5' %}selected{% endif %}>5</option>
                <option value="15" {% if lignes_par_page == '15' %}selected{% endif %}>15</option>
                <option value="30" {% if lignes_par_page == '30' %}selected{% endif %}>30</option>
                <option value="100" {% if lignes_par_page == '100' %}selected{% endif %}>100</option>
            </select>
        </form>
    
        <!-- Pagination -->
        <div class="flex items-center space-x-2">
            <span class="mx-2">Page {{ page_obj.number }} sur {{ page_obj.paginator.num_pages }}</span>
            <div class="flex space-x-2">
                {% if page_obj.has_previous %}
                    <a href="?page=1&lignes={{ lignes_par_page }}" class="px-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 12H5M12 5l-7 7 7 7"/>
                        </svg></a>
                    <a href="?page={{ page_obj.previous_page_number }}&lignes={{ lignes_par_page }}" class="px-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M15 18l-6-6 6-6"/>
                        </svg>
                    </a>
                {% endif %}
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}&lignes={{ lignes_par_page }}" class="px-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 6l6 6-6 6"/>
                        </svg>
                    </a>
                    <a href="?page={{ page_obj.paginator.num_pages }}&lignes={{ lignes_par_page }}" class="px-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M5 12h14M12 19l7-7-7-7"/>
                        </svg>
                    </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Filtrage sorties -->
    <form method="GET" action="{% url 'caisse:liste_sorties' %}" class="p-4" id="filter-form">
        <div class="flex items-center dark:bg-secondary rounded-xl  space-x-4 text-sm">
            <div class="flex space-x-4">
                <!-- Sélecteur Catégories -->
                <select name="categorie" class="w-[30%] px-8 py-2 border-none dark:bg-secondary focus:ring-0" onchange="document.getElementById('filter-form').submit();">
                    <option value="">Catégories</option>
                    {% for categorie in categories %}
                        <option value="{{ categorie.id }}" {% if request.GET.categorie == categorie.id|stringformat:"s" %}selected{% endif %}>
                            {{ categorie.name }}
                        </option>
                    {% endfor %}
                </select>
                <div class="h-10 w-0.5 bg-gray-300"></div>
    
                <!-- Sélecteur Bénéficiaires -->
                <select name="beneficiaire" class="px py-2 border-none dark:bg-secondary focus:ring-0 rounded-md" onchange="document.getElementById('filter-form').submit();">
                    <option value="">Bénéficiaires</option>
                    {% for beneficiaire in beneficiaires %}
                        <option value="{{ beneficiaire.id }}" {% if request.GET.beneficiaire == beneficiaire.id|stringformat:"s" %}selected{% endif %}>
                            {{ beneficiaire.name }}
                        </option>
                    {% endfor %}
                </select>
                <div class="h-10 w-0.5 bg-gray-300"></div>
    
                <!-- Sélecteur Fournisseurs -->
                <select name="fournisseur" class="px py-2 bg-white border-none dark:bg-secondary focus:ring-0 rounded-md" onchange="document.getElementById('filter-form').submit();">
                    <option value="">Fournisseurs</option>
                    {% for fournisseur in fournisseurs %}
                        <option value="{{ fournisseur.id }}" {% if request.GET.fournisseur == fournisseur.id|stringformat:"s" %}selected{% endif %}>
                            {{ fournisseur.name }}
                        </option>
                    {% endfor %}
                </select>
                <div class="h-10 w-0.5 bg-gray-300"></div>
    
                <!-- Sélecteur de Tri -->
                <div class="flex space-x-4">
                    <!-- Date de début -->
                    <input type="date" name="date_min" placeholder="Date de début" value="{{ request.GET.date_min }}" onchange="document.getElementById('filter-form').submit();"
                            class="px-4 py-2  dark:bg-secondary  border-none rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none">
        
                    <!-- Date de fin -->
                    <input type="date" name="date_max" placeholder="Date de fin" value="{{ request.GET.date_max }}" onchange="document.getElementById('filter-form').submit();"
                            class="px-4 py-2 dark:bg-secondary border-none rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none">
                </div>
                <div class="h-10 w-0.5 bg-gray-300"></div>
    
                <!-- Bouton pour réinitialiser les filtres -->
                <a href="{% url 'caisse:liste_sorties' %}" class="text-red px-3 py-2 hover:text-red-700 flex items-center space-x-1">
                    <i class="fas fa-sync-alt"></i>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M23 4v6h-6"/>
                        <path d="M1 20v-6h6"/>
                        <path d="M3.51 9a9 9 0 0114.13-3.36L23 10M1 14l4.36 4.36A9 9 0 0020.49 15"/>
                    </svg>
                    <span>Reset</span>
                </a>
            </div>
        </div>
    </form>

    <!-- Tableau des opérations -->
    <form method="post" id="export-form" action="{% url 'caisse:generer_excel_operations_sorties' %}">
        {% csrf_token %}
        <input type="hidden" id="selected-operations-input" name="selected_operations_ids">
        <div class="overflow-x-auto bg-white text-sm dark:bg-secondary dark:text-white border-none rounded-lg">
    <table class="w-full">
        <thead>
            <tr class="uppercase text-sm border-b">
                <th class="px-4 py-1 text-left">
                    <input type="checkbox" id="select-all-sorties">
                </th>
                <th class="px-4 py-1 text-left">
                    {% if request.GET.sort == 'description' and request.GET.order == 'asc' %}
                        <a href="?sort=description&order=desc&lignes={{ lignes_par_page }}">Description ⬇</a>
                    {% else %}
                        <a href="?sort=description&order=asc&lignes={{ lignes_par_page }}">Description ⬆</a>
                    {% endif %}
                </th>
                <th class="px-4 py-1 text-left">
                    {% if request.GET.sort == 'categorie' and request.GET.order == 'asc' %}
                        <a href="?sort=categorie&order=desc&lignes={{ lignes_par_page }}">Catégorie ⬇</a>
                    {% else %}
                        <a href="?sort=categorie&order=asc&lignes={{ lignes_par_page }}">Catégorie ⬆</a>
                    {% endif %}
                </th>
                <th class="px-4 py-1 text-left">
                    {% if request.GET.sort == 'beneficiaire' and request.GET.order == 'asc' %}
                        <a href="?sort=beneficiaire&order=desc&lignes={{ lignes_par_page }}">Bénéficiaire ⬇</a>
                    {% else %}
                        <a href="?sort=beneficiaire&order=asc&lignes={{ lignes_par_page }}">Bénéficiaire ⬆</a>
                    {% endif %}
                </th>
                <th class="px-4 py-1 text-left">
                    {% if request.GET.sort == 'fournisseur' and request.GET.order == 'asc' %}
                        <a href="?sort=fournisseur&order=desc&lignes={{ lignes_par_page }}">Fournisseur ⬇</a>
                    {% else %}
                        <a href="?sort=fournisseur&order=asc&lignes={{ lignes_par_page }}">Fournisseur ⬆</a>
                    {% endif %}
                </th>
                <th class="px-4 py-1 text-left">
                    {% if request.GET.sort == 'date' and request.GET.order == 'asc' %}
                        <a href="?sort=date&order=desc&lignes={{ lignes_par_page }}">Date ⬇</a>
                    {% else %}
                        <a href="?sort=date&order=asc&lignes={{ lignes_par_page }}">Date ⬆</a>
                    {% endif %}
                </th>
                <th class="px-4 py-1 text-right">Quantité</th>
                <th class="px-4 py-1 text-right">Montant</th>
                <th class="px-4 py-1 text-center">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for operation in page_obj %}
            <tr :key="{{ operation.id }}" class="{% cycle 'bg-white dark:bg-secondary' 'bg-gray-300 dark:bg-blue-950' %} border-b border-white">
                <td class="px-4 py-2">
                    <input type="checkbox" name="selected_operations" value="{{ operation.id }}">
                </td>
                <td class="py-1 px-4">{{ operation.description }}</td>
                <td class="py-1 px-4">{{ operation.categorie.name }}</td>
                <td class="py-1 px-4">
                    {% if operation.beneficiaire.personnel %}
                        {{ operation.beneficiaire.personnel }}
                    {% elif operation.beneficiaire.name %}
                        {{ operation.beneficiaire.name }}
                    {% else %}
                        Bénéficiaire non spécifié
                    {% endif %}
                </td>
                <td class="py-1 px-4">{{ operation.fournisseur.name }}</td>
                <td class="py-1 px-4">{{ operation.date_de_sortie }}</td>
                <td class="py-1 px-4 text-right">{{ operation.quantite }}</td>
                <td class="py-1 px-4 text-right">{{ operation.montant|intcomma }} Ar</td>
                <td class="py-1 px-4 text-right">
                    <div class="flex justify-center items-center space-x-2 border dark:border-white rounded-2xl">
                        <!-- Icône de modification (stylo) -->
                        <a href="{% url 'caisse:modifier_sortie' operation.id %}" class="p-2 rounded-lg hover:bg-gray-200">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                class="h-5 w-5 inline" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round"
                                    stroke-linejoin="round" stroke-width="2"
                                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                        </a>
                        <div class="h-10 bg-secondary dark:bg-white" style="width: 1px;"></div>
                        <!-- Icône de suppression -->
                        <a href="{% url 'caisse:supprimer_sortie' operation.id %}" class="p-2 rounded-lg hover:bg-gray-200" onclick="return confirm('Êtes-vous sûr de vouloir supprimer cette entrée ?');">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-rose-500" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
    
        <!-- Boutons d'exportation -->
        <div class="flex justify-end mt-4">
            <button type="button" onclick="validateAndSubmitExport('selected')" 
            class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
            Exporter Sélection
        </button>
        <button type="button" onclick="validateAndSubmitExport('all')" 
            class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded ml-2">
            Exporter Tout
        </button>
        </div>
    </form>
    
    <script>
        function validateAndSubmitExport(type) {
            const checkboxes = document.querySelectorAll('input[name="selected_operations"]:checked');
            const form = document.getElementById('export-form');
            
            if (type === 'selected' && checkboxes.length === 0) {
                alert('Veuillez sélectionner au moins une opération à exporter');
                return false;
            }
            
            if (type === 'all') {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'export_all';
                input.value = 'true';
                form.appendChild(input);
            } else {
                const selectedIds = Array.from(checkboxes).map(cb => cb.value);
                document.getElementById('selected-operations-input').value = selectedIds.join(',');
            }
            
            form.submit();
        }
        document.getElementById('select-all-entrees').addEventListener('click', function(event) {
            const checkboxes = document.querySelectorAll('input[name="selected_operations"]');
            checkboxes.forEach(checkbox => checkbox.checked = event.target.checked);
        });
    </script>
</div> 

{% endblock %}