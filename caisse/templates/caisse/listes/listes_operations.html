<!-- templates/listes/index.html -->
{% extends 'layout/layout.html' %}

{% block title %}Liste des Opérations{% endblock %}

{% block content %}
<div x-data="operationsData()" class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-6">Liste des Opérations</h1>

    <div class="bg-white border rounded-lg overflow-hidden">
        <div class="flex justify-between items-center p-4 bg-gray-50">
            <div class="flex space-x-2">
                <button @click="activeTab = 'entrees'"
                    :class="{ 'text-blue-600 border-b-2 border-blue-600': activeTab === 'entrees' }"
                    class="px-3 py-2 font-medium">Entrées</button>
                <button @click="activeTab = 'sorties'"
                    :class="{ 'text-blue-600 border-b-2 border-blue-600': activeTab === 'sorties' }"
                    class="px-3 py-2 font-medium">Sorties</button>
            </div>
            <button @click="openNewOperation()"
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                <a href="{% url 'operation' %}">Nouvelle opération</a>
            </button>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="bg-gray-100">
                        <th class="px-4 py-2 text-left">Description</th>
                        <th class="px-4 py-2 text-left">Catégories</th>
                        <th class="px-4 py-2 text-left">Bénéficiaires</th>
                        <th class="px-4 py-2 text-left">Fournisseurs</th>
                        <th class="px-4 py-2 text-left">Dates</th>
                        <th class="px-4 py-2 text-right">Quantités</th>
                        <th class="px-4 py-2 text-right">Sommes</th>
                        <th class="px-4 py-2 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="operation in filteredOperations"
                        :key="operation.id">
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-4 py-2"
                                x-text="operation.description"></td>
                            <td class="px-4 py-2"
                                x-text="operation.category"></td>
                            <td class="px-4 py-2"
                                x-text="operation.beneficiary"></td>
                            <td class="px-4 py-2"
                                x-text="operation.supplier"></td>
                            <td class="px-4 py-2" x-text="operation.date"></td>
                            <td class="px-4 py-2 text-right"
                                x-text="operation.quantity"></td>
                            <td class="px-4 py-2 text-right"
                                x-text="formatCurrency(operation.amount)"></td>
                            <td class="px-4 py-2 text-center">
                                <button @click="editOperation(operation)"
                                    class="text-blue-600 hover:text-blue-800 mr-2">
                                    <i class="fas fa-edit">modifier</i>
                                </button>
                                <button @click="deleteOperation(operation)"
                                    class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash">supprimer</i>
                                </button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal pour la modification -->
    <div x-show="showEditModal"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full"
        x-cloak>
        <div
            class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="absolute top-0 right-0 mt-4 mr-4">
                <button @click="closeEditModal()"
                    class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900"
                    x-text="editingOperation ? (editingOperation.type === 'entree' ? 'Modifier l\'entrée' : 'Modifier la sortie') : ''"></h3>
                <div class="mt-2 px-7 py-3">
                    <input type="text" x-model="editingOperation.description"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                        placeholder="Description">
                    <input type="text" x-model="editingOperation.category"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                        placeholder="Catégorie">
                    <input type="text" x-model="editingOperation.beneficiary"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                        placeholder="Bénéficiaire">
                    <input type="text" x-model="editingOperation.supplier"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                        placeholder="Fournisseur">
                    <input type="date" x-model="editingOperation.date"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    <input type="number" x-model="editingOperation.quantity"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                        placeholder="Quantité">
                    <input type="number" x-model="editingOperation.amount"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                        placeholder="Montant">
                </div>
                <div class="items-center px-4 py-3">
                    <button @click="saveEdit()"
                        class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        Enregistrer
                    </button>
                    <button @click="closeEditModal()"
                        class="mt-2 px-4 py-2 bg-gray-300 text-gray-700 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Annuler
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function operationsData() {
    return {
        activeTab: 'entrees',
        showEditModal: false,
        editingOperation: null,
        operations: [
            { id: 1, type: 'entree', description: 'Entrée caisse', category: 'Catégorie-1', beneficiary: '', supplier: 'Juliet', date: '2024-08-01', quantity: 1, amount: 400000 },
            { id: 2, type: 'entree', description: 'Entrée caisse', category: 'Catégorie-1', beneficiary: '', supplier: 'Juliet', date: '2024-07-03', quantity: 1, amount: 100000 },
            { id: 3, type: 'sortie', description: 'Achat de Casque', category: 'Matériel', beneficiary: 'Employé-1', supplier: 'USB', date: '2024-08-03', quantity: 1, amount: 30000 },
            { id: 4, type: 'sortie', description: 'Savon', category: 'Produit Ménagers', beneficiary: 'Toilette', supplier: 'Epicerie', date: '2024-07-12', quantity: 2, amount: 2800 },
            { id: 5, type: 'sortie', description: 'Eau de javel', category: 'Produit Ménagers', beneficiary: 'Cuisine', supplier: 'Epicerie', date: '2024-07-12', quantity: 1, amount: 2000 },
        ],
        get filteredOperations() {
            return this.operations.filter(op => op.type === this.activeTab.slice(0, -1));
        },
        formatCurrency(amount) {
            return new Intl.NumberFormat('fr-MG', { style: 'currency', currency: 'MGA' }).format(amount).replace('MGA', 'Ar');
        },
        openNewOperation() {
            // Implement the logic to open the new operation form
            console.log('Opening new operation form');
        },
        editOperation(operation) {
            this.editingOperation = { ...operation };
            this.showEditModal = true;
        },
        saveEdit() {
            const index = this.operations.findIndex(op => op.id === this.editingOperation.id);
            if (index !== -1) {
                this.operations[index] = { ...this.editingOperation };
            }
            this.closeEditModal();
        },
        deleteOperation(operation) {
            // Implement the logic to delete an operation
            console.log('Deleting operation:', operation);
        },
        closeEditModal() {
            this.showEditModal = false;
            this.editingOperation = null;
        }
    }
}
</script>
{% endblock %}
